@{
    // Thiết lập tiêu đề trang
    ViewData["Title"] = "Quản lý Biên Lai";
    Layout = "_Layout"; // Sử dụng layout mặc định của dự án
}
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body {
            margin: 0;
            padding-bottom: 70px; /* chừa khoảng trống cho footer */
            background-color: #f8f9fa;
        }

        .loader-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: transparent;
            width: auto;
            height: auto;
            z-index: 2000;
        }

        .hidden {
            display: none !important;
        }

        /* Styling cho Loader (Giữ nguyên) */
        .loader {
            --cloud-color: #4387f4;
            --arrows-color: #80b1ff;
            --time-animation: 1s;
            transform: scale(1);
        }

            .loader #cloud {
                width: 100px;
                height: 100px;
            }

                .loader #cloud rect {
                    fill: var(--cloud-color);
                }

                .loader #cloud g:nth-child(3) {
                    transform-origin: 50% 72.8938%;
                    fill: var(--arrows-color);
                    filter: drop-shadow(0 0 8px black);
                    animation: rotation var(--time-animation) linear infinite;
                }

            .loader #shapes g g circle {
                animation: cloud calc(var(--time-animation) * 2) linear infinite;
            }

                .loader #shapes g g circle:nth-child(2) {
                    animation-delay: calc((var(--time-animation) * 2) / -3);
                }

                .loader #shapes g g circle:nth-child(3) {
                    animation-delay: calc((var(--time-animation) * 2) / -1.5);
                }

            .loader svg #lines g line {
                stroke-width: 5;
                transform-origin: 50% 50%;
                rotate: -65deg;
                animation: lines calc(var(--time-animation) / 1.33) linear infinite;
            }

        @@keyframes rotation {
            0% {
                transform: rotate(0deg);
            }

            50% {
                transform: rotate(180deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @@keyframes lines {
            0% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(8px);
            }
        }

        @@keyframes cloud {
            0% {
                cx: 20;
                cy: 60;
                r: 15;
            }

            50% {
                cx: 50;
                cy: 45;
                r: 20;
            }

            100% {
                cx: 80;
                cy: 60;
                r: 15;
            }
        }

        /* Styling cho Bảng (Giữ nguyên) */
        .table-container {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            background-color: #ffffff;
            transition: all 0.3s ease;
        }

        .table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 15px;
            color: #333;
            margin: 0;
        }

            .table thead {
                background: linear-gradient(90deg, #007bff, #00b4d8);
                color: #fff;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                font-weight: 600;
            }

                .table thead th {
                    padding: 14px 16px;
                    border: none;
                }

            .table tbody tr {
                transition: background-color 0.25s ease, transform 0.1s ease;
            }

                .table tbody tr:hover {
                    background-color: rgba(0, 123, 255, 0.08);
                    transform: scale(1.005);
                }

            .table tbody td {
                padding: 12px 14px;
                vertical-align: middle;
                border-top: 1px solid #e9ecef;
            }

                .table tbody td:first-child {
                    font-weight: 500;
                    color: #007bff;
                }

            .table tbody tr:last-child td {
                border-bottom: none;
            }

            .table td .btn {
                font-size: 14px;
                padding: 6px 10px;
            }

                .table td .btn i {
                    margin-right: 4px;
                }

        /* Hiệu ứng badge trạng thái */
        .badge {
            font-size: 13px;
            padding: 6px 10px;
            border-radius: 8px;
        }

        /* Responsive - bảng cuộn ngang nếu màn hình nhỏ */
        @@media (max-width: 768px) {
            .table-container {
                overflow-x: auto;
                box-shadow: none;
            }
        }
    </style>
</head>
<div class="container mx-auto px-4 py-6">
    <h2 class="text-2xl font-bold mb-6 text-center text-primary">Quản lý Biên Lai</h2>

    <div class="row mb-4 align-items-center">
        <div class="col-md-6 order-md-1">
            <div class="input-group">
                <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm theo Số BL, Mã SV, Mã Lớp, Tháng/Năm...">
                <button class="btn btn-outline-primary" type="button" id="btnSearch">
                    <i class="bi bi-search"></i> Tìm kiếm
                </button>
            </div>
        </div>
        <div class="col-md-6 text-md-end text-start order-md-2 mt-3 mt-md-0">
            <button class="btn btn-primary" id="btnAddBL" data-bs-toggle="modal" data-bs-target="#modalAdd">
                <i class="bi bi-plus-circle"></i> Thêm Biên Lai
            </button>
        </div>
    </div>

    <div class="table-container mt-4">
        <table class="table table-striped table-hover text-center align-middle">
            <thead class="bg-primary text-white">
                <tr>
                    <th>Số BL</th>
                    <th>Thời Gian</th>
                    <th>Mã Lớp</th>
                    <th>Mã SV</th>
                    <th>Số Tiền</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody id="blTableBody">
                <tr>
                    <div id="data-loading-indicator" class="loader-overlay hidden">
                        <div class="loader">
                            <svg id="cloud" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                                <defs>
                                    <filter id="roundness">
                                        <feGaussianBlur in="SourceGraphic" stdDeviation="1.5"></feGaussianBlur>
                                        <feColorMatrix values="1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 20 -10"></feColorMatrix>
                                    </filter>
                                    <mask id="shapes">
                                        <g fill="white">
                                            <polygon points="50 37.5 80 75 20 75 50 37.5"></polygon>
                                            <circle cx="20" cy="60" r="15"></circle>
                                            <circle cx="80" cy="60" r="15"></circle>
                                            <g>
                                                <circle cx="20" cy="60" r="15"></circle>
                                                <circle cx="20" cy="60" r="15"></circle>
                                                <circle cx="20" cy="60" r="15"></circle>
                                            </g>
                                        </g>
                                    </mask>
                                    <mask id="clipping" clipPathUnits="userSpaceOnUse">
                                        <g id="lines" filter="url(#roundness)">
                                            <g mask="url(#shapes)" stroke="white">
                                                <line x1="-50" y1="-40" x2="150" y2="-40"></line>
                                                <line x1="-50" y1="-31" x2="150" y2="-31"></line>
                                                <line x1="-50" y1="-22" x2="150" y2="-22"></line>
                                                <line x1="-50" y1="-13" x2="150" y2="-13"></line>
                                                <line x1="-50" y1="-4" x2="150" y2="-4"></line>
                                                <line x1="-50" y1="5" x2="150" y2="5"></line>
                                                <line x1="-50" y1="14" x2="150" y2="14"></line>
                                                <line x1="-50" y1="23" x2="150" y2="23"></line>
                                                <line x1="-50" y1="32" x2="150" y2="32"></line>
                                                <line x1="-50" y1="41" x2="150" y2="41"></line>
                                                <line x1="-50" y1="50" x2="150" y2="50"></line>
                                                <line x1="-50" y1="59" x2="150" y2="59"></line>
                                                <line x1="-50" y1="68" x2="150" y2="68"></line>
                                                <line x1="-50" y1="77" x2="150" y2="77"></line>
                                                <line x1="-50" y1="86" x2="150" y2="86"></line>
                                                <line x1="-50" y1="95" x2="150" y2="95"></line>
                                                <line x1="-50" y1="104" x2="150" y2="104"></line>
                                                <line x1="-50" y1="113" x2="150" y2="113"></line>
                                                <line x1="-50" y1="122" x2="150" y2="122"></line>
                                                <line x1="-50" y1="131" x2="150" y2="131"></line>
                                                <line x1="-50" y1="140" x2="150" y2="140"></line>
                                            </g>
                                        </g>
                                    </mask>
                                </defs>
                                <rect x="0"
                                      y="0"
                                      width="100"
                                      height="100"
                                      rx="0"
                                      ry="0"
                                      mask="url(#clipping)"></rect>
                                <g>
                                    <path d="M33.52,68.12 C35.02,62.8 39.03,58.52 44.24,56.69 C49.26,54.93 54.68,55.61 59.04,58.4 C59.04,58.4 56.24,60.53 56.24,60.53 C55.45,61.13 55.68,62.37 56.63,62.64 C56.63,62.64 67.21,65.66 67.21,65.66 C67.98,65.88 68.75,65.3 68.74,64.5 C68.74,64.5 68.68,53.5 68.68,53.5 C68.67,52.51 67.54,51.95 66.75,52.55 C66.75,52.55 64.04,54.61 64.04,54.61 C57.88,49.79 49.73,48.4 42.25,51.03 C35.2,53.51 29.78,59.29 27.74,66.49 C27.29,68.08 28.22,69.74 29.81,70.19 C30.09,70.27 30.36,70.31 30.63,70.31 C31.94,70.31 33.14,69.44 33.52,68.12Z"></path>
                                    <path d="M69.95,74.85 C68.35,74.4 66.7,75.32 66.25,76.92 C64.74,82.24 60.73,86.51 55.52,88.35 C50.51,90.11 45.09,89.43 40.73,86.63 C40.73,86.63 43.53,84.51 43.53,84.51 C44.31,83.91 44.08,82.67 43.13,82.4 C43.13,82.4 32.55,79.38 32.55,79.38 C31.78,79.16 31.02,79.74 31.02,80.54 C31.02,80.54 31.09,91.54 31.09,91.54 C31.09,92.53 32.22,93.09 33.01,92.49 C33.01,92.49 35.72,90.43 35.72,90.43 C39.81,93.63 44.77,95.32 49.84,95.32 C52.41,95.32 55,94.89 57.51,94.01 C64.56,91.53 69.99,85.75 72.02,78.55 C72.47,76.95 71.54,75.3 69.95,74.85Z"></path>
                                </g>
                            </svg>
                        </div>
                    </div>
                </tr>
            </tbody>
        </table>
    </div>

    <nav aria-label="Phân trang Biên Lai" class="mt-4">
        <ul class="pagination justify-content-center" id="pagination-controls">
        </ul>
    </nav>
</div>

<div class="modal fade" id="modalAdd" tabindex="-1" aria-labelledby="modalAddLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalAddLabel">Thêm Biên Lai</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <form id="formAdd">
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">Tháng</label>
                            <input type="number" class="form-control" id="addThang" placeholder="Tháng (1-12)" min="1" max="12" required>
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">Năm</label>
                            <input type="number" class="form-control" id="addNam" placeholder="Năm (Ví dụ: 2025)" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mã Lớp</label>
                        <input type="text" class="form-control" id="addMaLop" placeholder="Nhập Mã Lớp (Ví dụ: LOP01)" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mã SV</label>
                        <input type="text" class="form-control" id="addMaSv" placeholder="Nhập Mã Sinh Viên (Ví dụ: SV007)" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Số Tiền</label>
                        <input type="number" class="form-control" id="addSoTien" placeholder="Nhập số tiền (VND)" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" id="btnSubmitAdd" class="btn btn-primary">Thêm</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalDetail" tabindex="-1" aria-labelledby="modalDetailLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="modalDetailLabel">Chi Tiết Biên Lai</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <p><strong>Số BL:</strong> <span id="detailSoBienLai"></span></p>
                <p><strong>Thời Gian:</strong> <span id="detailThoiGian"></span></p>
                <p><strong>Mã Lớp:</strong> <span id="detailMaLop"></span></p>
                <p><strong>Mã SV:</strong> <span id="detailMaSv"></span></p>
                <p><strong>Số Tiền:</strong> <span id="detailSoTien"></span> VND</p>
                <p><strong>Row Guid:</strong> <span id="detailRowGuid"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEdit" tabindex="-1" aria-labelledby="modalEditLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="modalEditLabel">Chỉnh Sửa Biên Lai</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <form id="formEdit">
                    <input type="hidden" id="editRowGuid">
                    <input type="hidden" id="editMaLopKey"> <input type="hidden" id="editMaSvKey">
                    <div class="mb-3">
                        <label class="form-label">Số BL</label>
                        <input type="text" class="form-control" id="editSoBienLai" readonly>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">Tháng</label>
                            <input type="number" class="form-control" id="editThang" min="1" max="12" required>
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">Năm</label>
                            <input type="number" class="form-control" id="editNam" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mã Lớp</label>
                        <input type="text" class="form-control" id="editMaLop" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mã SV</label>
                        <input type="text" class="form-control" id="editMaSv" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Số Tiền</label>
                        <input type="number" class="form-control" id="editSoTien" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" id="btnSubmitEdit" class="btn btn-warning text-white">Lưu thay đổi</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalDelete" tabindex="-1" aria-labelledby="modalDeleteLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="modalDeleteLabel">Xác Nhận Xóa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn xóa Biên Lai của Mã Lớp <strong id="deleteMaLopText"></strong> và Mã SV <strong id="deleteMaSvText"></strong> không?</p>
                <input type="hidden" id="deleteTargetMaLop">
                <input type="hidden" id="deleteTargetMaSv">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" id="btnConfirmDelete" class="btn btn-danger">Xóa</button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        const apiUrl = "http://localhost:5057/api/BienLai";
        const tbody = document.getElementById("blTableBody");
        const loader = document.getElementById("data-loading-indicator");
        const paginationControls = document.getElementById("pagination-controls"); // 🆕 Element phân trang

        let blData = [];

        // 🆕 Biến phân trang
        const rowsPerPage = 7;
        let currentPage = 1;
        let currentFilteredData = []; // Dữ liệu hiện tại đang được phân trang/tìm kiếm

        // Hàm định dạng tiền tệ Việt Nam
        const formatter = new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND',
            minimumFractionDigits: 0
        });

        // 🟢 Hàm tìm BL theo Khóa Tổng Hợp
        function findBlByKeys(maLop, maSv) {
            return blData.find(bl => bl.maLop === maLop && bl.maSv === maSv);
        }

        // 🟢 Hàm hiển thị/ẩn loader
        function showLoader() {
            loader.classList.remove('hidden');
            tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Đang tải dữ liệu...</td></tr>`;
        }

        function hideLoader() {
            loader.classList.add('hidden');
        }

        // 🟡 Hàm hiển thị dữ liệu ra bảng (ĐÃ CẬP NHẬT PHÂN TRANG)
        function renderBls(dataToRender, page = 1) {
            currentPage = page;
            currentFilteredData = dataToRender; // Lưu trữ dữ liệu đang được phân trang

            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;

            // Lấy dữ liệu cho trang hiện tại
            const paginatedData = dataToRender.slice(startIndex, endIndex);

            if (!Array.isArray(paginatedData) || paginatedData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Không tìm thấy Biên Lai nào.</td></tr>`;
                paginationControls.innerHTML = '';
                return;
            }

            tbody.innerHTML = "";
            paginatedData.forEach(bl => {
                const soBienLai = bl.soBienLai ?? 'N/A';
                const thoiGian = `${bl.thang}/${bl.nam}` ?? 'N/A';
                const maLop = bl.maLop ?? 'N/A';
                const maSv = bl.maSv ?? 'N/A';
                const soTien = bl.soTien ? formatter.format(bl.soTien) : '0 VND';

                // Truyền Khóa Tổng Hợp vào onclick để định danh
                const keys = `'${maLop}', '${maSv}'`;

                tbody.innerHTML += `
                            <tr>
                                <td>${soBienLai}</td>
                                <td>${thoiGian}</td>
                                <td>${maLop}</td>
                                <td>${maSv}</td>
                                <td>${soTien}</td>
                                <td>
                                    <button class="btn btn-info btn-sm text-white" title="Xem chi tiết" onclick="showDetailModal(${keys})"><i class="bi bi-card-list"></i></button>
                                    <button class="btn btn-warning btn-sm text-white" title="Chỉnh sửa" onclick="showEditModal(${keys})"><i class="bi bi-pencil-square"></i></button>
                                    <button class="btn btn-danger btn-sm" title="Xóa" onclick="showDeleteModal(${keys})"><i class="bi bi-trash"></i></button>
                                </td>
                            </tr>
                        `;
            });

            setupPagination(dataToRender); // Cập nhật các nút phân trang
        }

        // 🆕 Hàm tạo các nút phân trang
        function setupPagination(data) {
            paginationControls.innerHTML = '';
            const pageCount = Math.ceil(data.length / rowsPerPage);

            if (pageCount <= 1) return; // Không cần phân trang nếu chỉ có 1 trang

            // Nút 'Trang trước'
            const prevDisabled = currentPage === 1 ? 'disabled' : '';
            paginationControls.innerHTML += `
                        <li class="page-item ${prevDisabled}">
                            <a class="page-link" href="#" onclick="changePage(event, ${currentPage - 1})">Trước</a>
                        </li>
                    `;

            // Các nút số trang
            for (let i = 1; i <= pageCount; i++) {
                const active = i === currentPage ? 'active' : '';
                paginationControls.innerHTML += `
                            <li class="page-item ${active}">
                                <a class="page-link" href="#" onclick="changePage(event, ${i})">${i}</a>
                            </li>
                        `;
            }

            // Nút 'Trang sau'
            const nextDisabled = currentPage === pageCount ? 'disabled' : '';
            paginationControls.innerHTML += `
                        <li class="page-item ${nextDisabled}">
                            <a class="page-link" href="#" onclick="changePage(event, ${currentPage + 1})">Sau</a>
                        </li>
                    `;
        }

        // 🆕 Hàm chuyển trang
        function changePage(event, newPage) {
            event.preventDefault();
            const pageCount = Math.ceil(currentFilteredData.length / rowsPerPage);

            if (newPage >= 1 && newPage <= pageCount) {
                renderBls(currentFilteredData, newPage);
            }
        }

        // 🟢 Hàm load danh sách Biên Lai từ API (Tải toàn bộ dữ liệu)
        async function loadBls() {
            showLoader();
            blData = [];

            try {
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Lỗi HTTP: ${response.status}. Chi tiết: ${errorText.substring(0, 100)}`);
                }

                const data = await response.json();
                blData = data;

                // Lần đầu tải, hiển thị trang 1
                renderBls(blData, 1);

            } catch (err) {
                console.error("Lỗi khi tải Biên Lai:", err);
                tbody.innerHTML = `<tr><td colspan="6" class="text-danger text-center">
                                                <strong>❌ Lỗi tải dữ liệu.</strong> Vui lòng kiểm tra API: ${err.message}
                                            </td></tr>`;
                paginationControls.innerHTML = '';
            } finally {
                hideLoader();
            }
        }

        // 🆕 Hàm hỗ trợ tải lại dữ liệu và chuyển đến trang cụ thể
        async function loadBlsAfterAction(targetPage) {
            showLoader();
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`Lỗi HTTP: ${response.status}`);

                blData = await response.json();

                // Đảm bảo trang đích không vượt quá số trang tối đa
                const maxPage = Math.ceil(blData.length / rowsPerPage);
                const finalPage = Math.min(targetPage, maxPage) || 1;

                renderBls(blData, finalPage);
            } catch (err) {
                console.error("Lỗi khi tải lại Biên Lai:", err);
            } finally {
                hideLoader();
            }
        }


        function handleSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();

            let filteredBls;
            if (!searchTerm) {
                filteredBls = blData;
            } else {
                filteredBls = blData.filter(bl => {
                    const soBlStr = bl.soBienLai ? String(bl.soBienLai) : '';
                    const maLop = bl.maLop ? bl.maLop.toLowerCase() : '';
                    const maSv = bl.maSv ? bl.maSv.toLowerCase() : '';
                    const thoiGian = `${bl.thang}/${bl.nam}`;

                    return soBlStr.includes(searchTerm) ||
                        maLop.includes(searchTerm) ||
                        maSv.includes(searchTerm) ||
                        thoiGian.includes(searchTerm);
                });
            }

            // Luôn hiển thị kết quả tìm kiếm/toàn bộ dữ liệu bắt đầu từ trang 1
            renderBls(filteredBls, 1);
        }

        function showDetailModal(maLop, maSv) {
            const bl = findBlByKeys(maLop, maSv);
            if (!bl) return alert("Không tìm thấy Biên Lai này.");

            document.getElementById('detailSoBienLai').textContent = bl.soBienLai;
            document.getElementById('detailThoiGian').textContent = `${bl.thang}/${bl.nam}`;
            document.getElementById('detailMaLop').textContent = bl.maLop ?? 'N/A';
            document.getElementById('detailMaSv').textContent = bl.maSv ?? 'N/A';
            document.getElementById('detailSoTien').textContent = bl.soTien ? formatter.format(bl.soTien) : '0';
            document.getElementById('detailRowGuid').textContent = bl.rowguid ?? 'N/A';
            new bootstrap.Modal(document.getElementById('modalDetail')).show();
        }

        function showEditModal(maLop, maSv) {
            const bl = findBlByKeys(maLop, maSv);
            if (!bl) return alert("Không tìm thấy Biên Lai này.");

            document.getElementById('editSoBienLai').value = bl.soBienLai;
            document.getElementById('editThang').value = bl.thang;
            document.getElementById('editNam').value = bl.nam;
            document.getElementById('editMaLop').value = bl.maLop ?? '';
            document.getElementById('editMaSv').value = bl.maSv ?? '';
            document.getElementById('editSoTien').value = bl.soTien ?? '';
            document.getElementById('editRowGuid').value = bl.rowguid;

            // Lưu Khóa Tổng Hợp vào hidden fields để dùng khi submit
            document.getElementById('editMaLopKey').value = maLop;
            document.getElementById('editMaSvKey').value = maSv;

            new bootstrap.Modal(document.getElementById('modalEdit')).show();
        }

        function showDeleteModal(maLop, maSv) {
            const bl = findBlByKeys(maLop, maSv);
            if (!bl) return alert("Không tìm thấy Biên Lai này.");

            document.getElementById('deleteMaLopText').textContent = maLop;
            document.getElementById('deleteMaSvText').textContent = maSv;

            // Lưu Khóa Tổng Hợp vào hidden fields để dùng khi submit
            document.getElementById('deleteTargetMaLop').value = maLop;
            document.getElementById('deleteTargetMaSv').value = maSv;

            new bootstrap.Modal(document.getElementById('modalDelete')).show();
        }

        // ============================= 🚀 CHỨC NĂNG API (POST, PUT, DELETE) 🚀 =================

        async function handleAddSubmit() {
            const thang = parseInt(document.getElementById('addThang').value);
            const nam = parseInt(document.getElementById('addNam').value);
            const maLop = document.getElementById('addMaLop').value;
            const maSv = document.getElementById('addMaSv').value;
            const soTien = parseFloat(document.getElementById('addSoTien').value);

            if (isNaN(thang) || isNaN(nam) || !maLop || !maSv || isNaN(soTien)) {
                return alert('Vui lòng nhập đầy đủ và chính xác thông tin Biên Lai.');
            }

            const newBl = { thang, nam, maLop, maSv, soTien };
            showLoader();

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newBl)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Lỗi khi Thêm Biên Lai: ${response.status}. Chi tiết: ${errorText.substring(0, 100)}`);
                }

                bootstrap.Modal.getInstance(document.getElementById('modalAdd')).hide();
                document.getElementById('formAdd').reset();

                alert('Thêm Biên Lai thành công! (Số BL được tạo tự động)');
                // Sau khi thêm, tải lại và chuyển về trang 1
                await loadBlsAfterAction(1);

            } catch (err) {
                console.error("Lỗi khi thêm Biên Lai:", err);
                alert(`Thêm thất bại. Lỗi: ${err.message}`);
            } finally {
                hideLoader();
            }
        }

        // 2. CHỨC NĂNG CHỈNH SỬA (PUT)
        async function handleEditSubmit() {
            const maLop = document.getElementById('editMaLopKey').value;
            const maSv = document.getElementById('editMaSvKey').value;

            const soBienLai = parseInt(document.getElementById('editSoBienLai').value); // Gửi lại ID cũ
            const thang = parseInt(document.getElementById('editThang').value);
            const nam = parseInt(document.getElementById('editNam').value);
            const soTien = parseFloat(document.getElementById('editSoTien').value);
            const rowguid = document.getElementById('editRowGuid').value;

            if (isNaN(thang) || isNaN(nam) || isNaN(soTien)) {
                return alert('Vui lòng nhập đầy đủ và chính xác thông tin Biên Lai.');
            }

            // API PUT cần cả khóa chính composite (maLop, maSv) trên URL và dữ liệu cập nhật trong body
            const updatedBlBody = { soBienLai, thang, nam, soTien, rowguid };

            const editUrl = `${apiUrl}/${maLop}/${maSv}`;
            showLoader();

            try {
                const response = await fetch(editUrl, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedBlBody)
                });

                if (response.status === 204 || response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('modalEdit')).hide();
                    alert(`Chỉnh sửa Biên Lai thành công!`);
                    // Giữ nguyên trang hiện tại sau khi chỉnh sửa
                    await loadBlsAfterAction(currentPage);
                } else {
                    const errorText = await response.text();
                    throw new Error(`Lỗi khi Chỉnh sửa Biên Lai: ${response.status}. Chi tiết: ${errorText.substring(0, 100)}`);
                }

            } catch (err) {
                console.error("Lỗi khi chỉnh sửa Biên Lai:", err);
                alert(`Chỉnh sửa thất bại. Lỗi: ${err.message}`);
            } finally {
                hideLoader();
            }
        }

        // 3. CHỨC NĂNG XÓA (DELETE)
        async function handleDeleteConfirm() {
            const maLop = document.getElementById('deleteTargetMaLop').value;
            const maSv = document.getElementById('deleteTargetMaSv').value;

            // URL sử dụng Khóa Tổng Hợp
            const deleteUrl = `${apiUrl}/${maLop}/${maSv}`;
            showLoader();

            try {
                const response = await fetch(deleteUrl, {
                    method: 'DELETE'
                });

                if (response.status === 204 || response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('modalDelete')).hide();
                    alert(`Xóa Biên Lai của Lớp ${maLop} và SV ${maSv} thành công!`);
                    // Sau khi xóa, tải lại và kiểm tra lại trang hiện tại (có thể phải lùi về trang trước)
                    await loadBlsAfterAction(currentPage);
                } else {
                    const errorText = await response.text();
                    throw new Error(`Lỗi khi Xóa Biên Lai: ${response.status}. Chi tiết: ${errorText.substring(0, 100)}`);
                }

            } catch (err) {
                console.error("Lỗi khi xóa Biên Lai:", err);
                alert(`Xóa thất bại. Lỗi: ${err.message}`);
            } finally {
                hideLoader();
            }
        }


        function fixModalA11y(modalId, elementToFocus) {
            const modalElement = document.getElementById(modalId);
            modalElement.addEventListener('hidden.bs.modal', function () {
                elementToFocus.focus();
            });
        }

        // Cần gán các hàm này vào window để các thuộc tính `onclick` trong HTML được render có thể gọi
        window.changePage = changePage;
        window.showDetailModal = showDetailModal;
        window.showEditModal = showEditModal;
        window.showDeleteModal = showDeleteModal;


        document.addEventListener("DOMContentLoaded", () => {
            loadBls(); // Tải dữ liệu ban đầu

            // Gắn sự kiện cho các nút Submit
            document.getElementById('btnSubmitAdd').addEventListener('click', handleAddSubmit);
            document.getElementById('btnSubmitEdit').addEventListener('click', handleEditSubmit);
            document.getElementById('btnConfirmDelete').addEventListener('click', handleDeleteConfirm);

            // Gắn sự kiện cho Tìm kiếm
            document.getElementById('btnSearch').addEventListener('click', handleSearch);
            document.getElementById('searchInput').addEventListener('keyup', (event) => {
                // Cập nhật kết quả trực tiếp khi gõ
                handleSearch();
            });

            // Áp dụng fix A11y cho tất cả modal
            const btnAddBL = document.getElementById('btnAddBL');
            fixModalA11y('modalAdd', btnAddBL);
            fixModalA11y('modalDetail', btnAddBL);
            fixModalA11y('modalEdit', btnAddBL);
            fixModalA11y('modalDelete', btnAddBL);
        });
    </script>
}