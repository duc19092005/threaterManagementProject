@{
    // Thiết lập tiêu đề trang
    ViewData["Title"] = "Quản lý Giảng Viên";
    Layout = "_Layout"; // Sử dụng layout mặc định của dự án
}
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body {
            margin: 0;
            padding-bottom: 70px; /* chừa khoảng trống cho footer */
            background-color: #f8f9fa;
        }

        .loader-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: transparent;
            width: auto;
            height: auto;
            z-index: 2000;
        }

        .hidden {
            display: none !important;
        }

        /* Styling cho Loader (Giữ nguyên) */
        .loader {
            --cloud-color: #4387f4;
            --arrows-color: #80b1ff;
            --time-animation: 1s;
            transform: scale(1);
        }

            .loader #cloud {
                width: 100px;
                height: 100px;
            }

                .loader #cloud rect {
                    fill: var(--cloud-color);
                }

                .loader #cloud g:nth-child(3) {
                    transform-origin: 50% 72.8938%;
                    fill: var(--arrows-color);
                    filter: drop-shadow(0 0 8px black);
                    animation: rotation var(--time-animation) linear infinite;
                }

            .loader #shapes g g circle {
                animation: cloud calc(var(--time-animation) * 2) linear infinite;
            }

                .loader #shapes g g circle:nth-child(2) {
                    animation-delay: calc((var(--time-animation) * 2) / -3);
                }

                .loader #shapes g g circle:nth-child(3) {
                    animation-delay: calc((var(--time-animation) * 2) / -1.5);
                }

            .loader svg #lines g line {
                stroke-width: 5;
                transform-origin: 50% 50%;
                rotate: -65deg;
                animation: lines calc(var(--time-animation) / 1.33) linear infinite;
            }

        @@keyframes rotation {
            0% {
                transform: rotate(0deg);
            }

            50% {
                transform: rotate(180deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @@keyframes lines {
            0% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(8px);
            }
        }

        @@keyframes cloud {
            0% {
                cx: 20;
                cy: 60;
                r: 15;
            }

            50% {
                cx: 50;
                cy: 45;
                r: 20;
            }

            100% {
                cx: 80;
                cy: 60;
                r: 15;
            }
        }

        /* Styling cho Bảng (Giữ nguyên) */
        .table-container {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            background-color: #ffffff;
            transition: all 0.3s ease;
        }

        .table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 15px;
            color: #333;
            margin: 0;
        }

            .table thead {
                background: linear-gradient(90deg, #007bff, #00b4d8);
                color: #fff;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                font-weight: 600;
            }

                .table thead th {
                    padding: 14px 16px;
                    border: none;
                }

            .table tbody tr {
                transition: background-color 0.25s ease, transform 0.1s ease;
            }

                .table tbody tr:hover {
                    background-color: rgba(0, 123, 255, 0.08);
                    transform: scale(1.005);
                }

            .table tbody td {
                padding: 12px 14px;
                vertical-align: middle;
                border-top: 1px solid #e9ecef;
            }

                .table tbody td:first-child {
                    font-weight: 500;
                    color: #007bff;
                }

            .table tbody tr:last-child td {
                border-bottom: none;
            }

            .table td .btn {
                font-size: 14px;
                padding: 6px 10px;
            }

                .table td .btn i {
                    margin-right: 4px;
                }

        /* Hiệu ứng badge trạng thái */
        .badge {
            font-size: 13px;
            padding: 6px 10px;
            border-radius: 8px;
        }

        /* Responsive - bảng cuộn ngang nếu màn hình nhỏ */
        @@media (max-width: 768px) {
            .table-container {
                overflow-x: auto;
                box-shadow: none;
            }
        }
    </style>
</head>
<div class="container mx-auto px-4 py-6">
    <h2 class="text-2xl font-bold mb-6 text-center text-primary">Quản lý Giảng Viên</h2>

    <div class="row mb-4 align-items-center">
        <div class="col-md-6 order-md-1">
            <div class="input-group">
                <input type="text" id="searchInput" class="form-control" placeholder="Nhập Mã GV hoặc Tên GV để tìm kiếm...">
                <button class="btn btn-outline-primary" type="button" id="btnSearch">
                    <i class="bi bi-search"></i> Tìm kiếm
                </button>
            </div>
        </div>
        <div class="col-md-6 text-md-end text-start order-md-2 mt-3 mt-md-0">
            <button class="btn btn-primary" id="btnAddGV" data-bs-toggle="modal" data-bs-target="#modalAdd">
                <i class="bi bi-plus-circle"></i> Thêm Giảng Viên
            </button>
        </div>
    </div>

    <div class="table-container mt-4">
        <table class="table table-striped table-hover text-center align-middle">
            <thead class="bg-primary text-white">
                <tr>
                    <th>Mã GV</th>
                    <th>Họ Tên GV</th>
                    <th>Mã CLB</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody id="gvTableBody">
                <tr>
                    <div id="data-loading-indicator" class="loader-overlay hidden">
                        <div class="loader">
                            <svg id="cloud" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                                <defs>
                                    <filter id="roundness">
                                        <feGaussianBlur in="SourceGraphic" stdDeviation="1.5"></feGaussianBlur>
                                        <feColorMatrix values="1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 20 -10"></feColorMatrix>
                                    </filter>
                                    <mask id="shapes">
                                        <g fill="white">
                                            <polygon points="50 37.5 80 75 20 75 50 37.5"></polygon>
                                            <circle cx="20" cy="60" r="15"></circle>
                                            <circle cx="80" cy="60" r="15"></circle>
                                            <g>
                                                <circle cx="20" cy="60" r="15"></circle>
                                                <circle cx="20" cy="60" r="15"></circle>
                                                <circle cx="20" cy="60" r="15"></circle>
                                            </g>
                                        </g>
                                    </mask>
                                    <mask id="clipping" clipPathUnits="userSpaceOnUse">
                                        <g id="lines" filter="url(#roundness)">
                                            <g mask="url(#shapes)" stroke="white">
                                                <line x1="-50" y1="-40" x2="150" y2="-40"></line>
                                                <line x1="-50" y1="-31" x2="150" y2="-31"></line>
                                                <line x1="-50" y1="-22" x2="150" y2="-22"></line>
                                                <line x1="-50" y1="-13" x2="150" y2="-13"></line>
                                                <line x1="-50" y1="-4" x2="150" y2="-4"></line>
                                                <line x1="-50" y1="5" x2="150" y2="5"></line>
                                                <line x1="-50" y1="14" x2="150" y2="14"></line>
                                                <line x1="-50" y1="23" x2="150" y2="23"></line>
                                                <line x1="-50" y1="32" x2="150" y2="32"></line>
                                                <line x1="-50" y1="41" x2="150" y2="41"></line>
                                                <line x1="-50" y1="50" x2="150" y2="50"></line>
                                                <line x1="-50" y1="59" x2="150" y2="59"></line>
                                                <line x1="-50" y1="68" x2="150" y2="68"></line>
                                                <line x1="-50" y1="77" x2="150" y2="77"></line>
                                                <line x1="-50" y1="86" x2="150" y2="86"></line>
                                                <line x1="-50" y1="95" x2="150" y2="95"></line>
                                                <line x1="-50" y1="104" x2="150" y2="104"></line>
                                                <line x1="-50" y1="113" x2="150" y2="113"></line>
                                                <line x1="-50" y1="122" x2="150" y2="122"></line>
                                                <line x1="-50" y1="131" x2="150" y2="131"></line>
                                                <line x1="-50" y1="140" x2="150" y2="140"></line>
                                            </g>
                                        </g>
                                    </mask>
                                </defs>
                                <rect x="0"
                                      y="0"
                                      width="100"
                                      height="100"
                                      rx="0"
                                      ry="0"
                                      mask="url(#clipping)"></rect>
                                <g>
                                    <path d="M33.52,68.12 C35.02,62.8 39.03,58.52 44.24,56.69 C49.26,54.93 54.68,55.61 59.04,58.4 C59.04,58.4 56.24,60.53 56.24,60.53 C55.45,61.13 55.68,62.37 56.63,62.64 C56.63,62.64 67.21,65.66 67.21,65.66 C67.98,65.88 68.75,65.3 68.74,64.5 C68.74,64.5 68.68,53.5 68.68,53.5 C68.67,52.51 67.54,51.95 66.75,52.55 C66.75,52.55 64.04,54.61 64.04,54.61 C57.88,49.79 49.73,48.4 42.25,51.03 C35.2,53.51 29.78,59.29 27.74,66.49 C27.29,68.08 28.22,69.74 29.81,70.19 C30.09,70.27 30.36,70.31 30.63,70.31 C31.94,70.31 33.14,69.44 33.52,68.12Z"></path>
                                    <path d="M69.95,74.85 C68.35,74.4 66.7,75.32 66.25,76.92 C64.74,82.24 60.73,86.51 55.52,88.35 C50.51,90.11 45.09,89.43 40.73,86.63 C40.73,86.63 43.53,84.51 43.53,84.51 C44.31,83.91 44.08,82.67 43.13,82.4 C43.13,82.4 32.55,79.38 32.55,79.38 C31.78,79.16 31.02,79.74 31.02,80.54 C31.02,80.54 31.09,91.54 31.09,91.54 C31.09,92.53 32.22,93.09 33.01,92.49 C33.01,92.49 35.72,90.43 35.72,90.43 C39.81,93.63 44.77,95.32 49.84,95.32 C52.41,95.32 55,94.89 57.51,94.01 C64.56,91.53 69.99,85.75 72.02,78.55 C72.47,76.95 71.54,75.3 69.95,74.85Z"></path>
                                </g>
                            </svg>
                        </div>
                    </div>
                </tr>
            </tbody>
        </table>
    </div>

    <nav aria-label="Phân trang Giảng Viên" class="mt-4">
        <ul class="pagination justify-content-center" id="pagination-controls">
        </ul>
    </nav>
</div>

<div class="modal fade" id="modalAdd" tabindex="-1" aria-labelledby="modalAddLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalAddLabel">Thêm Giảng Viên</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <form id="formAdd">
                    <div class="mb-3">
                        <label class="form-label">Họ Tên GV</label>
                        <input type="text" class="form-control" id="addHoTenGv" placeholder="Nhập Họ Tên Giảng Viên" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mã CLB</label>
                        <input type="text" class="form-control" id="addMaClb" placeholder="Nhập Mã CLB (Ví dụ: CLB01)" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" id="btnSubmitAdd" class="btn btn-primary">Thêm</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalDetail" tabindex="-1" aria-labelledby="modalDetailLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="modalDetailLabel">Chi Tiết Giảng Viên</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <p><strong>Mã GV:</strong> <span id="detailMaGv"></span></p>
                <p><strong>Họ Tên GV:</strong> <span id="detailHoTenGv"></span></p>
                <p><strong>Mã CLB:</strong> <span id="detailMaClb"></span></p>
                <p><strong>Row Guid:</strong> <span id="detailRowGuid"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEdit" tabindex="-1" aria-labelledby="modalEditLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="modalEditLabel">Chỉnh Sửa Giảng Viên</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <form id="formEdit">
                    <input type="hidden" id="editRowGuid">
                    <div class="mb-3">
                        <label class="form-label">Mã GV</label>
                        <input type="text" class="form-control" id="editMaGv" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Họ Tên GV</label>
                        <input type="text" class="form-control" id="editHoTenGv" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mã CLB</label>
                        <input type="text" class="form-control" id="editMaClb" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" id="btnSubmitEdit" class="btn btn-warning text-white">Lưu thay đổi</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalDelete" tabindex="-1" aria-labelledby="modalDeleteLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="modalDeleteLabel">Xác Nhận Xóa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn xóa Giảng Viên <strong id="deleteHoTenGv"></strong> (<span id="deleteMaGv"></span>) không?</p>
                <input type="hidden" id="deleteTargetMaGv">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" id="btnConfirmDelete" class="btn btn-danger">Xóa</button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        const apiUrl = "http://localhost:5057/api/giangVien";
        const tbody = document.getElementById("gvTableBody");
        const loader = document.getElementById("data-loading-indicator");
        const paginationControls = document.getElementById("pagination-controls"); // 🆕 Element phân trang

        let gvData = [];

        // 🆕 Biến phân trang
        const rowsPerPage = 7;
        let currentPage = 1;
        let currentFilteredData = []; // Dữ liệu hiện tại đang được phân trang/tìm kiếm

        // 🟢 Hàm tìm GV theo Mã GV
        function findGvByMaGv(maGv) {
            return gvData.find(gv => gv.maGv === maGv);
        }

        // 🟢 Hàm hiển thị/ẩn loader
        function showLoader() {
            loader.classList.remove('hidden');
            tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">Đang tải dữ liệu...</td></tr>`;
        }

        function hideLoader() {
            loader.classList.add('hidden');
        }

        // 🟡 Hàm hiển thị dữ liệu ra bảng (ĐÃ CẬP NHẬT PHÂN TRANG)
        function renderGvs(dataToRender, page = 1) {
            currentPage = page;
            currentFilteredData = dataToRender; // Lưu trữ dữ liệu đang được phân trang

            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;

            // Lấy dữ liệu cho trang hiện tại
            const paginatedData = dataToRender.slice(startIndex, endIndex);

            if (!Array.isArray(paginatedData) || paginatedData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">Không tìm thấy Giảng Viên nào.</td></tr>`;
                paginationControls.innerHTML = ''; // Ẩn phân trang nếu không có dữ liệu
                return;
            }

            tbody.innerHTML = "";
            paginatedData.forEach(gv => {
                const maGV = gv.maGv ?? 'N/A';
                const hoTenGV = gv.hoTenGv ?? 'Họ Tên bị thiếu';
                const maCLB = gv.maClb ?? 'Chưa gán';

                tbody.innerHTML += `
                            <tr>
                                <td>${maGV}</td>
                                <td>${hoTenGV}</td>
                                <td>${maCLB}</td>
                                <td>
                                    <button class="btn btn-info btn-sm text-white" title="Xem chi tiết" onclick="showDetailModal('${gv.maGv}')"><i class="bi bi-card-list"></i></button>
                                    <button class="btn btn-warning btn-sm text-white" title="Chỉnh sửa" onclick="showEditModal('${gv.maGv}')"><i class="bi bi-pencil-square"></i></button>
                                    <button class="btn btn-danger btn-sm" title="Xóa" onclick="showDeleteModal('${gv.maGv}')"><i class="bi bi-trash"></i></button>
                                </td>
                            </tr>
                        `;
            });

            setupPagination(dataToRender); // Cập nhật các nút phân trang
        }

        // 🆕 Hàm tạo các nút phân trang
        function setupPagination(data) {
            paginationControls.innerHTML = '';
            const pageCount = Math.ceil(data.length / rowsPerPage);

            if (pageCount <= 1) return; // Không cần phân trang nếu chỉ có 1 trang

            // Nút 'Trang trước'
            const prevDisabled = currentPage === 1 ? 'disabled' : '';
            paginationControls.innerHTML += `
                        <li class="page-item ${prevDisabled}">
                            <a class="page-link" href="#" onclick="changePage(event, ${currentPage - 1})">Trước</a>
                        </li>
                    `;

            // Các nút số trang
            for (let i = 1; i <= pageCount; i++) {
                const active = i === currentPage ? 'active' : '';
                paginationControls.innerHTML += `
                            <li class="page-item ${active}">
                                <a class="page-link" href="#" onclick="changePage(event, ${i})">${i}</a>
                            </li>
                        `;
            }

            // Nút 'Trang sau'
            const nextDisabled = currentPage === pageCount ? 'disabled' : '';
            paginationControls.innerHTML += `
                        <li class="page-item ${nextDisabled}">
                            <a class="page-link" href="#" onclick="changePage(event, ${currentPage + 1})">Sau</a>
                        </li>
                    `;
        }

        // 🆕 Hàm chuyển trang
        function changePage(event, newPage) {
            event.preventDefault();
            const pageCount = Math.ceil(currentFilteredData.length / rowsPerPage);

            if (newPage >= 1 && newPage <= pageCount) {
                renderGvs(currentFilteredData, newPage);
            }
        }


        async function loadGvs() {
            showLoader();
            gvData = [];

            try {
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Lỗi HTTP: ${response.status}. Chi tiết: ${errorText.substring(0, 100)}`);
                }

                const data = await response.json();
                gvData = data;

                // Lần đầu tải, hiển thị trang 1
                renderGvs(gvData, 1);

            } catch (err) {
                console.error("Lỗi khi tải Giảng Viên:", err);
                tbody.innerHTML = `<tr><td colspan="4" class="text-danger text-center">
                                                <strong>❌ Lỗi tải dữ liệu.</strong> Vui lòng kiểm tra API: ${err.message}
                                            </td></tr>`;
                paginationControls.innerHTML = '';
            } finally {
                hideLoader();
            }
        }

        function handleSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();

            let filteredGvs;
            if (!searchTerm) {
                filteredGvs = gvData;
            } else {
                filteredGvs = gvData.filter(gv => {
                    const maGV = gv.maGv ? gv.maGv.toLowerCase() : '';
                    const hoTenGV = gv.hoTenGv ? gv.hoTenGv.toLowerCase() : '';

                    return maGV.includes(searchTerm) || hoTenGV.includes(searchTerm);
                });
            }

            // Luôn hiển thị kết quả tìm kiếm/toàn bộ dữ liệu bắt đầu từ trang 1
            renderGvs(filteredGvs, 1);
        }

        function showDetailModal(maGv) {
            const gv = findGvByMaGv(maGv);
            if (!gv) return alert("Không tìm thấy dữ liệu Giảng Viên này.");

            document.getElementById('detailMaGv').textContent = gv.maGv;
            document.getElementById('detailHoTenGv').textContent = gv.hoTenGv;
            document.getElementById('detailMaClb').textContent = gv.maClb ?? 'N/A';
            document.getElementById('detailRowGuid').textContent = gv.rowguid ?? 'N/A';
            new bootstrap.Modal(document.getElementById('modalDetail')).show();
        }

        function showEditModal(maGv) {
            const gv = findGvByMaGv(maGv);
            if (!gv) return alert("Không tìm thấy dữ liệu Giảng Viên này.");

            document.getElementById('editMaGv').value = gv.maGv;
            document.getElementById('editHoTenGv').value = gv.hoTenGv;
            document.getElementById('editMaClb').value = gv.maClb ?? '';
            document.getElementById('editRowGuid').value = gv.rowguid;
            new bootstrap.Modal(document.getElementById('modalEdit')).show();
        }

        function showDeleteModal(maGv) {
            const gv = findGvByMaGv(maGv);
            if (!gv) return alert("Không tìm thấy dữ liệu Giảng Viên này.");

            document.getElementById('deleteHoTenGv').textContent = gv.hoTenGv;
            document.getElementById('deleteMaGv').textContent = gv.maGv;
            document.getElementById('deleteTargetMaGv').value = gv.maGv;
            new bootstrap.Modal(document.getElementById('modalDelete')).show();
        }

        // ============================= 🚀 CHỨC NĂNG API (POST, PUT, DELETE) 🚀 =================

        // 🆕 Hàm hỗ trợ tải lại dữ liệu và chuyển đến trang cụ thể
        async function loadGvsAfterAction(targetPage) {
            showLoader();
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`Lỗi HTTP: ${response.status}`);

                gvData = await response.json();

                // Đảm bảo trang đích không vượt quá số trang tối đa
                const maxPage = Math.ceil(gvData.length / rowsPerPage);
                const finalPage = Math.min(targetPage, maxPage) || 1;

                renderGvs(gvData, finalPage);
            } catch (err) {
                console.error("Lỗi khi tải lại GV:", err);
            } finally {
                hideLoader();
            }
        }

        // 1. CHỨC NĂNG THÊM MỚI (POST) - ĐÃ CẬP NHẬT
        async function handleAddSubmit() {
            const hoTenGv = document.getElementById('addHoTenGv').value;
            const maClb = document.getElementById('addMaClb').value;

            if (!hoTenGv || !maClb) {
                return alert('Vui lòng nhập đầy đủ Họ Tên GV và Mã CLB.');
            }

            const newGv = { hoTenGv, maClb };
            showLoader(); // Bắt đầu tải

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newGv)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Lỗi khi Thêm GV: ${response.status}. Chi tiết: ${errorText.substring(0, 100)}`);
                }

                bootstrap.Modal.getInstance(document.getElementById('modalAdd')).hide();
                document.getElementById('formAdd').reset();

                alert('Thêm Giảng Viên thành công! (ID được tạo tự động)');
                // Sau khi thêm, tải lại và chuyển về trang 1
                await loadGvsAfterAction(1);

            } catch (err) {
                console.error("Lỗi khi thêm GV:", err);
                alert(`Thêm thất bại. Lỗi: ${err.message}`);
            } finally {
                hideLoader(); // Kết thúc tải
            }
        }

        // 2. CHỨC NĂNG CHỈNH SỬA (PUT) - ĐÃ CẬP NHẬT
        async function handleEditSubmit() {
            const maGv = document.getElementById('editMaGv').value;
            const hoTenGv = document.getElementById('editHoTenGv').value;
            const maClb = document.getElementById('editMaClb').value;
            const rowguid = document.getElementById('editRowGuid').value;

            if (!hoTenGv || !maClb) {
                return alert('Vui lòng nhập đầy đủ Họ Tên GV và Mã CLB.');
            }

            const updatedGvBody = { maGv, hoTenGv, maClb, rowguid }; // Thêm maGv và rowguid vào body nếu API yêu cầu
            const editUrl = `${apiUrl}/${maGv}`;
            showLoader(); // Bắt đầu tải

            try {
                const response = await fetch(editUrl, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedGvBody)
                });

                if (response.status === 204 || response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('modalEdit')).hide();
                    alert(`Chỉnh sửa Giảng Viên ${maGv} thành công!`);
                    // Giữ nguyên trang hiện tại sau khi chỉnh sửa
                    await loadGvsAfterAction(currentPage);
                } else {
                    const errorText = await response.text();
                    throw new Error(`Lỗi khi Chỉnh sửa GV: ${response.status}. Chi tiết: ${errorText.substring(0, 100)}`);
                }

            } catch (err) {
                console.error("Lỗi khi chỉnh sửa GV:", err);
                alert(`Chỉnh sửa thất bại. Lỗi: ${err.message}`);
            } finally {
                hideLoader(); // Kết thúc tải
            }
        }

        // 3. CHỨC NĂNG XÓA (DELETE) - ĐÃ CẬP NHẬT
        async function handleDeleteConfirm() {
            const maGv = document.getElementById('deleteTargetMaGv').value;
            const deleteUrl = `${apiUrl}/${maGv}`;
            showLoader(); // Bắt đầu tải

            try {
                const response = await fetch(deleteUrl, {
                    method: 'DELETE'
                });

                if (response.status === 204 || response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('modalDelete')).hide();
                    alert(`Xóa Giảng Viên ${maGv} thành công!`);
                    // Sau khi xóa, tải lại và kiểm tra lại trang hiện tại (có thể phải lùi về trang trước)
                    await loadGvsAfterAction(currentPage);
                } else {
                    const errorText = await response.text();
                    throw new Error(`Lỗi khi Xóa GV: ${response.status}. Chi tiết: ${errorText.substring(0, 100)}`);
                }

            } catch (err) {
                console.error("Lỗi khi xóa GV:", err);
                alert(`Xóa thất bại. Lỗi: ${err.message}`);
            } finally {
                hideLoader(); // Kết thúc tải
            }
        }

        function fixModalA11y(modalId, elementToFocus) {
            const modalElement = document.getElementById(modalId);
            modalElement.addEventListener('hidden.bs.modal', function () {
                elementToFocus.focus();
            });
        }

        // Cần gán các hàm này vào window để các thuộc tính `onclick` trong HTML được render có thể gọi
        window.changePage = changePage;
        window.showDetailModal = showDetailModal;
        window.showEditModal = showEditModal;
        window.showDeleteModal = showDeleteModal;


        document.addEventListener("DOMContentLoaded", () => {
            loadGvs();

            // Gắn sự kiện cho các nút Submit
            document.getElementById('btnSubmitAdd').addEventListener('click', handleAddSubmit);
            document.getElementById('btnSubmitEdit').addEventListener('click', handleEditSubmit);
            document.getElementById('btnConfirmDelete').addEventListener('click', handleDeleteConfirm);

            // Gắn sự kiện cho Tìm kiếm
            document.getElementById('btnSearch').addEventListener('click', handleSearch);
            document.getElementById('searchInput').addEventListener('keyup', (event) => {
                handleSearch();
            });

            const btnAddGV = document.getElementById('btnAddGV');
            fixModalA11y('modalAdd', btnAddGV);
            fixModalA11y('modalDetail', btnAddGV);
            fixModalA11y('modalEdit', btnAddGV);
            fixModalA11y('modalDelete', btnAddGV);
        });
    </script>
}